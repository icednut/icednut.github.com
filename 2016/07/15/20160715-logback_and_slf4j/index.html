<!DOCTYPE html>
<html lang=Ko>
<head><meta name="generator" content="Hexo 3.8.0">
    <!-- so meta -->
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="HandheldFriendly" content="True">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <meta name="description" content="최근 Oozie에서 RabbitMQ로 메세지를 전송하는 Common Action 개발을 맡았다. 여기서 Action은 Spring Boot 기반으로 개발하고 있었는데 문제는 Spring Boot가 실행되면서 Logging 관련 라이브러리가 말썽을 일으켜 Spring Boot가 아예 실행조차 되질 않는 상황이 발생했다. 상황을 자세히 설명하자면 다음과 같다.">
<meta name="keywords" content="Logback,SLF4J,oozie">
<meta property="og:type" content="article">
<meta property="og:title" content="Logback &amp; SLF4J를 쓰면서 만났던 문제">
<meta property="og:url" content="http://icednut.github.io/2016/07/15/20160715-logback_and_slf4j/index.html">
<meta property="og:site_name" content="Icednut&#39;s Note">
<meta property="og:description" content="최근 Oozie에서 RabbitMQ로 메세지를 전송하는 Common Action 개발을 맡았다. 여기서 Action은 Spring Boot 기반으로 개발하고 있었는데 문제는 Spring Boot가 실행되면서 Logging 관련 라이브러리가 말썽을 일으켜 Spring Boot가 아예 실행조차 되질 않는 상황이 발생했다. 상황을 자세히 설명하자면 다음과 같다.">
<meta property="og:locale" content="Korean">
<meta property="og:updated_time" content="2018-09-29T06:00:58.152Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Logback &amp; SLF4J를 쓰면서 만났던 문제">
<meta name="twitter:description" content="최근 Oozie에서 RabbitMQ로 메세지를 전송하는 Common Action 개발을 맡았다. 여기서 Action은 Spring Boot 기반으로 개발하고 있었는데 문제는 Spring Boot가 실행되면서 Logging 관련 라이브러리가 말썽을 일으켜 Spring Boot가 아예 실행조차 되질 않는 상황이 발생했다. 상황을 자세히 설명하자면 다음과 같다.">
    
    
        
          
              <link rel="shortcut icon" href="/images/favicon.ico">
          
        
        
          
            <link rel="icon" type="image/png" href="/images/favicon-192x192.png" sizes="192x192">
          
        
        
          
            <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png">
          
        
    
    <!-- title -->
    <title>Logback &amp; SLF4J를 쓰면서 만났던 문제</title>
    <!-- styles -->
    <link rel="stylesheet" href="/css/style.css">
    <!-- persian styles -->
    
      <link rel="stylesheet" href="/css/rtl.css">
    
    <!-- rss -->
    
    
</head>

<body class="max-width mx-auto px3 ltr">
    
      <div id="header-post">
  <a id="menu-icon" href="#"><i class="fas fa-bars fa-lg"></i></a>
  <a id="menu-icon-tablet" href="#"><i class="fas fa-bars fa-lg"></i></a>
  <a id="top-icon-tablet" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');" style="display:none;"><i class="fas fa-chevron-up fa-lg"></i></a>
  <span id="menu">
    <span id="nav">
      <ul>
         
          <li><a href="/">Home</a></li>
         
          <li><a href="/about/">About</a></li>
         
          <li><a href="/archives/">Writing</a></li>
         
          <li><a href="/Search/">Search</a></li>
        
      </ul>
    </span>
    <br>
    <span id="actions">
      <ul>
        
        <li><a class="icon" href="/2016/08/03/20160803-ddd_reading_memo/"><i class="fas fa-chevron-left" aria-hidden="true" onmouseover="$('#i-prev').toggle();" onmouseout="$('#i-prev').toggle();"></i></a></li>
        
        
        <li><a class="icon" href="/2016/07/11/20160711-hello_world/"><i class="fas fa-chevron-right" aria-hidden="true" onmouseover="$('#i-next').toggle();" onmouseout="$('#i-next').toggle();"></i></a></li>
        
        <li><a class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fas fa-chevron-up" aria-hidden="true" onmouseover="$('#i-top').toggle();" onmouseout="$('#i-top').toggle();"></i></a></li>
        <li><a class="icon" href="#"><i class="fas fa-share-alt" aria-hidden="true" onmouseover="$('#i-share').toggle();" onmouseout="$('#i-share').toggle();" onclick="$('#share').toggle();return false;"></i></a></li>
      </ul>
      <span id="i-prev" class="info" style="display:none;">Previous post</span>
      <span id="i-next" class="info" style="display:none;">Next post</span>
      <span id="i-top" class="info" style="display:none;">Back to top</span>
      <span id="i-share" class="info" style="display:none;">Share post</span>
    </span>
    <br>
    <div id="share" style="display: none">
      <ul>
  <li><a class="icon" href="http://www.facebook.com/sharer.php?u=http://icednut.github.io/2016/07/15/20160715-logback_and_slf4j/"><i class="fab fa-facebook " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://twitter.com/share?url=http://icednut.github.io/2016/07/15/20160715-logback_and_slf4j/&text=Logback &amp; SLF4J를 쓰면서 만났던 문제"><i class="fab fa-twitter " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.linkedin.com/shareArticle?url=http://icednut.github.io/2016/07/15/20160715-logback_and_slf4j/&title=Logback &amp; SLF4J를 쓰면서 만났던 문제"><i class="fab fa-linkedin " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://pinterest.com/pin/create/bookmarklet/?url=http://icednut.github.io/2016/07/15/20160715-logback_and_slf4j/&is_video=false&description=Logback &amp; SLF4J를 쓰면서 만났던 문제"><i class="fab fa-pinterest " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=Logback &amp; SLF4J를 쓰면서 만났던 문제&body=Check out this article: http://icednut.github.io/2016/07/15/20160715-logback_and_slf4j/"><i class="fas fa-envelope " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://getpocket.com/save?url=http://icednut.github.io/2016/07/15/20160715-logback_and_slf4j/&title=Logback &amp; SLF4J를 쓰면서 만났던 문제"><i class="fab fa-get-pocket " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://reddit.com/submit?url=http://icednut.github.io/2016/07/15/20160715-logback_and_slf4j/&title=Logback &amp; SLF4J를 쓰면서 만났던 문제"><i class="fab fa-reddit " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.stumbleupon.com/submit?url=http://icednut.github.io/2016/07/15/20160715-logback_and_slf4j/&title=Logback &amp; SLF4J를 쓰면서 만났던 문제"><i class="fab fa-stumbleupon " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://digg.com/submit?url=http://icednut.github.io/2016/07/15/20160715-logback_and_slf4j/&title=Logback &amp; SLF4J를 쓰면서 만났던 문제"><i class="fab fa-digg " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.tumblr.com/share/link?url=http://icednut.github.io/2016/07/15/20160715-logback_and_slf4j/&name=Logback &amp; SLF4J를 쓰면서 만났던 문제&description="><i class="fab fa-tumblr " aria-hidden="true"></i></a></li>
</ul>

    </div>
    <div id="toc">
      <ol class="toc"><li class="toc-item toc-level-4"><a class="toc-link" href="#상황"><span class="toc-number">1.</span> <span class="toc-text">상황</span></a></li></ol><li class="toc-item toc-level-2"><a class="toc-link" href="#해결"><span class="toc-number"></span> <span class="toc-text">해결</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#그-외-앞으로-할-일…"><span class="toc-number">1.</span> <span class="toc-text">그 외 앞으로 할 일…</span></a></li></ol>
    </li></div>
  </span>
</div>

    
    <div class="content index my4">
        
        <article class="post" itemscope="" itemtype="http://schema.org/BlogPosting">
  <header>
    
    <h1 class="posttitle" itemprop="name headline">
        Logback &amp; SLF4J를 쓰면서 만났던 문제
    </h1>



    <div class="meta">
      <span class="author" itemprop="author" itemscope="" itemtype="http://schema.org/Person">
        <span itemprop="name">Icednut's Note</span>
      </span>
      
    <div class="postdate">
        <time datetime="2016-07-14T15:00:00.000Z" itemprop="datePublished">2016-07-15</time>
    </div>


      
    <div class="article-tag">
        <i class="fas fa-tag"></i>
        <a class="tag-link" href="/tags/Logback/">Logback</a>, <a class="tag-link" href="/tags/SLF4J/">SLF4J</a>, <a class="tag-link" href="/tags/oozie/">oozie</a>
    </div>


    </div>
  </header>
  

  <div class="content" itemprop="articleBody">
    <p>최근 Oozie에서 RabbitMQ로 메세지를 전송하는 Common Action 개발을 맡았다. 여기서 Action은 Spring Boot 기반으로 개발하고 있었는데 문제는 Spring Boot가 실행되면서 Logging 관련 라이브러리가 말썽을 일으켜 Spring Boot가 아예 실행조차 되질 않는 상황이 발생했다. 상황을 자세히 설명하자면 다음과 같다.</p>
<h4 id="상황"><a href="#상황" class="headerlink" title="상황"></a>상황</h4><ul>
<li>Oozie에서 Executable Jar를 실행하는 Action이 하나 있었다.</li>
<li>그런데 이 Jar파일은 Spring Boot Application 이었고, Jar 파일 안에는 관련 있는 디펜던시 라이브러리들이 모두 한데 묶여 포함되어 있었다. (한마디로 Fat Jar)</li>
<li><p>디펜던시 중에는 Logback-core-1.1.3, Logback-classic-1.1.3, Slf4j-api-7.1.13이 있었고, 하필 Oozie 클러스터에 Slf4j-log4j2가 존재하고 있었다.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">// TODO: 간략한 Dependency Tree 표기할 것</span><br></pre></td></tr></table></figure>
</li>
<li><p>다시 Spring Boot로 초점을 맞춰보면, Spring Boot가 Bootstraping 하면서 여러 Spring Event를 발생시키게 되는데 그 중에 하나가 org.springframework.boot.logging.LoggingApplicationListener이다.</p>
</li>
<li><p>여기서 LoggingApplicationListener가 ApplicationStartedEvent를 핸들링 할 때 발생하는데, ApplicationStartedEvent를 받으면 LoggingSystem의 구현체를 결정하고 그 구현체를 초기화하는 로직이 실행되게 된다.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">onApplicationStartedEvent</span><span class="params">(ApplicationStartedEvent event)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">this</span>.loggingSystem = LoggingSystem.get(event.getSpringApplication().getClassLoader());</span><br><span class="line">  <span class="keyword">this</span>.loggingSystem.beforeInitialize();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>문제는 LoggingSystem의 구현체를 결정할 때(LoggingSystem.get 메소드를 호출할 때) 현재 디펜던시 상황에 따라 LogbackLoggingSystem이 결정되고 초기화가 진행되는데 초기화 진행 중 StaticLoggerBinder에게 LoggerContext를 요청한 뒤 요청 결과물을 LoggerContext로 캐스팅을 진행할 때 결과물이 Log4jLoggerFactory라고 인식이 되어 캐스팅 불가능하게 되어 예외가 발생하며 시스템이 실행되질 않는다.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> LoggerContext <span class="title">getLoggerContext</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  ILoggerFactory factory = StaticLoggerBinder.getSingleton().getLoggerFactory();</span><br><span class="line">  Assert.isInstanceOf(LoggerContext.class, factory,</span><br><span class="line">      String.format(</span><br><span class="line">          <span class="string">"LoggerFactory is not a Logback LoggerContext but Logback is on "</span></span><br><span class="line">              + <span class="string">"the classpath. Either remove Logback or the competing "</span></span><br><span class="line">              + <span class="string">"implementation (%s loaded from %s). If you are using "</span></span><br><span class="line">              + <span class="string">"WebLogic you will need to add 'org.slf4j' to "</span></span><br><span class="line">              + <span class="string">"prefer-application-packages in WEB-INF/weblogic.xml"</span>,</span><br><span class="line">          factory.getClass(), getLocation(factory)));</span><br><span class="line">  <span class="keyword">return</span> (LoggerContext) factory;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>뭔소리인지 소스코드와 함께 다시 설명하자면 StaticLoggerBinder.getSingleton().getLoggerFactory()의 결과물이 Logback의 LoggerContext가 아니라 Slf4j-log4j2의 Log4jLoggerFactory가 반환된다는 소리이다.</p>
</li>
</ul>
<p>왜 이런 문제가 발생하는 것일까?<br>앞에서도 이미 말했지만 Logback과 Slf4j-log4j2에 각각 존재하는 StaticLoggerFactory의 구현체가 서로 다르기 때문에 발생하는 문제이다. 사실 java의 Logging 라이브러리를 조금 유심히 살펴본 사람이라면 금방 알아차릴 수 있는 문제이긴 하지만, 모르더라도 Logback과 Slf4j의 소스코드를 살펴보면 구현체가 뭐가 다른지를 알 수 있다. 그럼 어떻게 해결해야 될까?</p>
<p>위 문제의 원인을 요약하자면 다음과 같다.</p>
<ul>
<li>Oozie 클러스터에 있는 slf4j-log4j2 라이브러리 때문에 Spring boot에서 Logback과 오류를 일으킨다.  </li>
<li>문제는 Logback이 아니라 Spring boot에서 logback과 slf4j-log4j2를 같이 쓰면 오류를 발생시키는게 문제이다.  </li>
</ul>
<h2 id="해결"><a href="#해결" class="headerlink" title="해결"></a>해결</h2><ul>
<li>spring boot를 안쓰거나 (LoggingApplicationListener만 등록 안하게 하는 것도 방법일 것 같다.)</li>
<li>logback을 안쓰거나 (Logback을 안쓰고 Slf4j-log4j2를 쓰게 만드는 전략)</li>
<li>slf4j-log4j2의 LoggerFactory가 인식되기 전에 logback-classic의 LoggerFactory가 인식되게 해야 한다. (아니면 StaticLoggerBinder가 강제로 Logback의 것으로 하게 한다던가..)</li>
</ul>
<p>일단 가장 간단한 해결 방법은 Logback을 안쓰는 방법이다. 그런데 그렇게하면 더 이상 파일이나 Standard Output (System.out)으로 로그를 볼 수 없다.<br>그럼 로그도 정상적으로 출력되면서 라이브러리 충돌도 안일으키게 하려면 어떻게 해야될까?</p>
<h4 id="그-외-앞으로-할-일…"><a href="#그-외-앞으로-할-일…" class="headerlink" title="그 외 앞으로 할 일…"></a>그 외 앞으로 할 일…</h4><p>이번 문제가 어느 정도 해결이 되고 나면 Java의 Logging 라이브러리를 좀 더 연구해봐야 겠다. Logback과 Slf4j의 공식 사이트가서 영어 까막눈이 레퍼런스를 들여다봐도 장님 코끼리 더듬는 느낌이다…</p>

  </div>
</article>

    <div class="blog-post-comments">
        <div id="disqus_thread">
            <noscript>Please enable JavaScript to view the comments.</noscript>
        </div>
    </div>



    </div>
    
      <div id="footer-post-container">
  <div id="footer-post">

    <div id="nav-footer" style="display: none">
      <ul>
         
          <li><a href="/">Home</a></li>
         
          <li><a href="/about/">About</a></li>
         
          <li><a href="/archives/">Writing</a></li>
         
          <li><a href="/Search/">Search</a></li>
        
      </ul>
    </div>

    <div id="toc-footer" style="display: none">
      <ol class="toc"><li class="toc-item toc-level-4"><a class="toc-link" href="#상황"><span class="toc-number">1.</span> <span class="toc-text">상황</span></a></li></ol><li class="toc-item toc-level-2"><a class="toc-link" href="#해결"><span class="toc-number"></span> <span class="toc-text">해결</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#그-외-앞으로-할-일…"><span class="toc-number">1.</span> <span class="toc-text">그 외 앞으로 할 일…</span></a></li></ol>
    </li></div>

    <div id="share-footer" style="display: none">
      <ul>
  <li><a class="icon" href="http://www.facebook.com/sharer.php?u=http://icednut.github.io/2016/07/15/20160715-logback_and_slf4j/"><i class="fab fa-facebook fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://twitter.com/share?url=http://icednut.github.io/2016/07/15/20160715-logback_and_slf4j/&text=Logback &amp; SLF4J를 쓰면서 만났던 문제"><i class="fab fa-twitter fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.linkedin.com/shareArticle?url=http://icednut.github.io/2016/07/15/20160715-logback_and_slf4j/&title=Logback &amp; SLF4J를 쓰면서 만났던 문제"><i class="fab fa-linkedin fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://pinterest.com/pin/create/bookmarklet/?url=http://icednut.github.io/2016/07/15/20160715-logback_and_slf4j/&is_video=false&description=Logback &amp; SLF4J를 쓰면서 만났던 문제"><i class="fab fa-pinterest fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=Logback &amp; SLF4J를 쓰면서 만났던 문제&body=Check out this article: http://icednut.github.io/2016/07/15/20160715-logback_and_slf4j/"><i class="fas fa-envelope fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://getpocket.com/save?url=http://icednut.github.io/2016/07/15/20160715-logback_and_slf4j/&title=Logback &amp; SLF4J를 쓰면서 만났던 문제"><i class="fab fa-get-pocket fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://reddit.com/submit?url=http://icednut.github.io/2016/07/15/20160715-logback_and_slf4j/&title=Logback &amp; SLF4J를 쓰면서 만났던 문제"><i class="fab fa-reddit fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.stumbleupon.com/submit?url=http://icednut.github.io/2016/07/15/20160715-logback_and_slf4j/&title=Logback &amp; SLF4J를 쓰면서 만났던 문제"><i class="fab fa-stumbleupon fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://digg.com/submit?url=http://icednut.github.io/2016/07/15/20160715-logback_and_slf4j/&title=Logback &amp; SLF4J를 쓰면서 만났던 문제"><i class="fab fa-digg fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.tumblr.com/share/link?url=http://icednut.github.io/2016/07/15/20160715-logback_and_slf4j/&name=Logback &amp; SLF4J를 쓰면서 만났던 문제&description="><i class="fab fa-tumblr fa-lg" aria-hidden="true"></i></a></li>
</ul>

    </div>

    <div id="actions-footer">
        <a id="menu" class="icon" href="#" onclick="$('#nav-footer').toggle();return false;"><i class="fas fa-bars fa-lg" aria-hidden="true"></i> Menu</a>
        <a id="toc" class="icon" href="#" onclick="$('#toc-footer').toggle();return false;"><i class="fas fa-list fa-lg" aria-hidden="true"></i> TOC</a>
        <a id="share" class="icon" href="#" onclick="$('#share-footer').toggle();return false;"><i class="fas fa-share-alt fa-lg" aria-hidden="true"></i> Share</a>
        <a id="top" style="display:none" class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fas fa-chevron-up fa-lg" aria-hidden="true"></i> Top</a>
    </div>

  </div>
</div>

    
    <footer id="footer">
  <div class="footer-left">
    Copyright &copy; 2018 Icednut
  </div>
  <div class="footer-right">
    <nav>
      <ul>
         
          <li><a href="/">Home</a></li>
         
          <li><a href="/about/">About</a></li>
         
          <li><a href="/archives/">Writing</a></li>
         
          <li><a href="/Search/">Search</a></li>
        
      </ul>
    </nav>
  </div>
</footer>

</body>
</html>
<!-- styles -->
<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">
<link rel="stylesheet" href="/lib/justified-gallery/css/justifiedGallery.min.css">

<!-- jquery -->
<script src="/lib/jquery/jquery.min.js"></script>
<script src="/lib/justified-gallery/js/jquery.justifiedGallery.min.js"></script>
<script src="/js/main.js"></script>
<!-- search -->

<!-- Google Analytics -->

<!-- Baidu Analytics -->

<!-- Disqus Comments -->

    <script type="text/javascript">
        var disqus_shortname = 'icednut';

        (function(){
            var dsq = document.createElement('script');
            dsq.type = 'text/javascript';
            dsq.async = true;
            dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        }());
    </script>


